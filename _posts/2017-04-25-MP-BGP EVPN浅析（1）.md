---
published: true
title: MP-BGP EVPN浅析（1）
layout: post
categories: jekyll update
---
## MP-BGP EVPN浅析（1）
VXLAN技术已经被认为是数据中心网络中最重要的技术（之一），但在IETF所定义的标准中（RFC7348），却并没有定义VXLAN的控制平面。它对远程VXLAN 隧道终端 (VTEP) 对等体的发现和远程终端主机的学习依靠数据驱动的“泛洪和学习”行为，重叠广播、未知单播和组播流量封装到组播 VXLAN 数据包并通过底层组播转发传输到远程 VTEP 交换机。此类部署中的泛洪可能给解决方案的可扩展性带来挑战。在底层网络中启用组播功能的要求也会带来挑战，因为某些组织不希望在其数据中心或广域网网络中启用组播。为了克服 RFC 7348 中定义的“泛洪和学习” VXLAN 的局限性，IETF又制定了多协议边界网关协议以太网虚拟专用网络(MP-BGP EVPN) 用作 VXLAN的控制平面。
   
ps: VXLAN天然的分离了数据平面和控制平面，为引入SDN作为控制平面做了铺垫。但MP-BGP EVPN作为一种演进性的技术，也是非常重要的。
 
### MP-BGP EVPN概述
 
虚拟专有局域网（Virtual Private LAN Service,VPLS）[RFC4664][RFC4761][RFC4762],是已经被证明并广泛使用的网络技术。然而，现有的解决方案在多宿主和冗余、多播优化、配置简易性、基于流的负载均衡、多路径问题等方面还存在许多问题；而这些问题却是数据中心网络部署所要认真考虑的。[RFC7209] 描述了一个新方案来解决这些问题的必要性。同时，它也列出了新的解决方案所必须要解决的一系列问题。
   
本文档描述了一个基于BGP MPLS的解决方案，被称为以太网VPN（EVPN）,来解决[RFC7209]所列出的一些列问题。EVPN要求对现在IP/MPLS协议扩展。除了这些扩展，而且EVPN也使用MPLS技术的许多构建模块。
本章节对MP-BGP EVPN进行了概述。一个EVPN实例由用户边缘设备（Customer Edge devices，CEs）和服务商边缘设备（Provider Edge devices ,PEs）组成。一个CE可以是一个主机，路由器或是交换机。PE提供CEs之间的虚拟二层桥接。在一个服务商网络中可以有多个EVPN实例。

 PEs之间可以由LSP架构来连接，从而带来了MPLS技术上许多优点，例如快速重路由、弹性等。PEs之间也可以由IP架构来连接，即通过IP/GRE隧道或其他IP隧道来实现PEs之间的连接。
在EVPN中，PEs之间的MAC学习不是发生在数据平面（例如VPLS中的传统桥接技术 [RFC4761] [RFC4762]），而是发生在控制平面。控制平面对MAC地址的学习过程具有良好控制，例如限制谁学习什么，策略应用能力等。而且，控制平面通告MAC可达性信息采用了多协议BGP (MP-BGP), 类似于IP VPNs[RFC4364]。

 这就提供了灵活性和一种能力来保持“虚拟化”或交互代理（主机、服务器、虚拟机等）之间的组隔离。在EVPN中，PEs通告从相连的CEs那里学习而来的MAC地址,沿着一个MPLS标签，通告给控制平面的使用Multi-protocol BGP (MP-BGP)的其他PEs。控制平面的学习可以促使来自或到达CEs的流量负载平衡，换句话说，它允许CEs连接多个附着的点，它也提高了当网络发生故障时的收敛时间。
然而，PEs和CEs之间的学习是通过数据平面驱动的：是通过该方法最好适用于CE：数据平面学习，IEEE 802.1x、链路层发现协议（LLDP），IEEE 802.1aq，地址解析协议（ARP）、管理平面或其他协议。

 需要注意的是，PE上的二层转发表是否要填充控制层所知道的所有的MAC目的地址，或者PE是否要实现一个cache-based的方案这都是本地化的决定。例如，MAC转发表可能只填充转发到特定PE的互动流的MAC目的地址。
EVPN的策略属性和IP VPN非常相似。一个EVPN实例要求一个路由区分符，该路由区分符是每个MAC-VRF所特有的，同时EVPN还要求一个或多个全局唯一的路由目标。

 CE附着到PE的MAC-VRF上，在以太网接口可能会配置一个或多个以太网标签，例如：VLAN ID。许多部署场景保证在EVPN实例中有唯一的VLAN ID：对于给定的EVPN实例的所有附着点，使用相同的VLAN ID, 其他的EVPN 实例不能使用这个VLAN ID。该文件是指本案为“独特的VLAN EVPN”,并且描述简化的过程以优化它。
